// Prisma Schema for IKF Project Livetracker

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROJECT_MANAGER
  TEAM_MEMBER
  CLIENT
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum StageStatus {
  OFF
  ON
  IN_PROGRESS
  CLOSED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String
  firstName      String
  lastName       String
  profilePicture String? // URL or path to profile picture
  role           UserRole @default(TEAM_MEMBER)
  departmentId   String?
  hourlyRate     Float?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  department            Department?       @relation("DepartmentMembers", fields: [departmentId], references: [id], onDelete: SetNull)
  managedProjects       Project[]         @relation("ProjectManager")
  projectMemberships    ProjectMember[]
  timesheets            Timesheet[]
  createdProjects       Project[]         @relation("ProjectCreator")
  createdDepartments    Department[]      @relation("DepartmentCreator")
  headedDepartments     Department[]      @relation("DepartmentHead")
  assignedTasks         Task[]            @relation("TaskAssignee")
  createdTasks          Task[]            @relation("TaskCreator")
  resourceCapacity      ResourceCapacity?
  templatesCreated      ProjectTemplate[] @relation("TemplateCreator")
  approvalChainsCreated ApprovalChain[]   @relation("ApprovalChainCreator")
  approvalRequests      ApprovalRequest[] @relation("ApprovalRequester")
  approvalsGiven        ApprovalRequest[] @relation("ApprovalApprover")

  @@index([email])
  @@index([role])
  @@index([departmentId])
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  headId      String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  head     User?     @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  creator  User      @relation("DepartmentCreator", fields: [createdById], references: [id])
  members  User[]    @relation("DepartmentMembers")
  projects Project[]

  @@index([headId])
}

model Customer {
  id            String         @id @default(uuid())
  name          String
  industry      String?
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  status        CustomerStatus @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  projects Project[]

  @@index([status])
  @@index([name])
}

model Stage {
  id            String   @id @default(uuid())
  name          String   @unique
  type          String   @default("Standard") // Standard or Temporary
  defaultWeight Float    @default(0) // Percentage
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  projectStages ProjectStage[]
  tasks         Task[]         @relation("StageTasks")
}

model Project {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  description  String?
  customerId   String?
  managerId    String?
  departmentId String?
  status       ProjectStatus @default(PLANNING)
  budget       Float         @default(0)
  startDate    DateTime?
  endDate      DateTime?
  healthScore  Float? // 0-100
  isArchived   Boolean       @default(false)
  archivedAt   DateTime?
  createdById  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  customer   Customer?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  manager    User?           @relation("ProjectManager", fields: [managerId], references: [id], onDelete: SetNull)
  department Department?     @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  creator    User            @relation("ProjectCreator", fields: [createdById], references: [id])
  members    ProjectMember[]
  stages     ProjectStage[]
  timesheets Timesheet[]
  resources  Resource[]
  tasks      Task[]

  @@index([code])
  @@index([status])
  @@index([managerId])
  @@index([customerId])
  @@index([departmentId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([isArchived])
}

model ProjectMember {
  id         String   @id @default(uuid())
  projectId  String
  userId     String
  assignedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model ProjectStage {
  id            String      @id @default(uuid())
  projectId     String
  stageId       String
  weight        Float       @default(0) // Percentage
  status        StageStatus @default(OFF)
  completedDate DateTime?
  createdAt     DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stage   Stage   @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@unique([projectId, stageId])
  @@index([projectId])
}

model Timesheet {
  id             String          @id @default(uuid())
  userId         String
  projectId      String
  taskId         String? // Link to specific task
  date           DateTime
  hours          Float // 0.5-24
  description    String?
  status         TimesheetStatus @default(DRAFT)
  approvedById   String?
  approvedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@index([status])
  @@index([userId, date])
  @@index([projectId, status])
  @@index([status, date])
  @@index([userId, status, date]) // Composite index for common query patterns
}

model Resource {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String // Sitemap, Content, Design, Development, QA, Template, Library
  projectId   String?
  url         String? // Google Drive or other external link
  accessLevel String   @default("Team") // Team, Public, Restricted
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([type])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id             String       @id @default(uuid())
  projectId      String
  assignedToId   String?
  title          String
  description    String?      @db.Text
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  dueDate        DateTime?
  stageId        String?
  estimatedHours Float?
  actualHours    Float?
  createdById    String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo     User?            @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  stage          Stage?           @relation("StageTasks", fields: [stageId], references: [id], onDelete: SetNull)
  creator        User             @relation("TaskCreator", fields: [createdById], references: [id])
  timesheets     Timesheet[]
  dependsOn      TaskDependency[] @relation("TaskDependencies")
  dependentTasks TaskDependency[] @relation("DependentTasks")

  @@index([projectId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([projectId, status]) // Composite index for project task filtering
  @@index([assignedToId, status]) // Composite index for user task filtering
  @@index([dueDate]) // Index for due date queries
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([entityType, createdAt]) // Composite index for entity type queries with date
  @@index([userId, createdAt]) // Composite index for user activity queries
}

model TaskDependency {
  id              String   @id @default(uuid())
  taskId          String
  dependsOnTaskId String
  createdAt       DateTime @default(now())

  task          Task @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOnTask Task @relation("DependentTasks", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
}

model ProjectTemplate {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?
  stages          Json // Array of stage IDs with weights
  defaultBudget   Float?
  defaultDuration Int? // Days
  isActive        Boolean  @default(true)
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  creator User @relation("TemplateCreator", fields: [createdById], references: [id])

  @@index([isActive])
}

model ResourceCapacity {
  id                String    @id @default(uuid())
  userId            String    @unique
  weeklyHours       Float     @default(40) // Standard weekly capacity
  currentAllocation Float     @default(0) // Current hours allocated
  startDate         DateTime?
  endDate           DateTime? // For temporary capacity changes
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ApprovalChain {
  id          String   @id @default(uuid())
  name        String
  entityType  String // TIMESHEET, PROJECT, etc.
  steps       Json // Array of approval steps with roles/users
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator          User              @relation("ApprovalChainCreator", fields: [createdById], references: [id])
  approvalRequests ApprovalRequest[]

  @@index([entityType, isActive])
}

model ApprovalRequest {
  id             String    @id @default(uuid())
  entityType     String
  entityId       String
  chainId        String
  currentStep    Int       @default(0)
  status         String    @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedById  String
  approvedById   String?
  approvedAt     DateTime?
  rejectedReason String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  chain     ApprovalChain @relation(fields: [chainId], references: [id])
  requester User          @relation("ApprovalRequester", fields: [requestedById], references: [id])
  approver  User?         @relation("ApprovalApprover", fields: [approvedById], references: [id])

  @@index([entityType, entityId])
  @@index([status])
  @@index([requestedById])
}
