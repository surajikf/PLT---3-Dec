// Prisma Schema for IKF Project Livetracker

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROJECT_MANAGER
  TEAM_MEMBER
  CLIENT
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum StageStatus {
  OFF
  ON
  IN_PROGRESS
  CLOSED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  role          UserRole  @default(TEAM_MEMBER)
  departmentId  String?
  hourlyRate    Float?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  department    Department? @relation("DepartmentMembers", fields: [departmentId], references: [id], onDelete: SetNull)
  managedProjects Project[] @relation("ProjectManager")
  projectMemberships ProjectMember[]
  timesheets    Timesheet[]
  createdProjects Project[] @relation("ProjectCreator")
  createdDepartments Department[] @relation("DepartmentCreator")
  headedDepartments Department[] @relation("DepartmentHead")
  assignedTasks Task[] @relation("TaskAssignee")
  createdTasks Task[] @relation("TaskCreator")

  @@index([email])
  @@index([role])
  @@index([departmentId])
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  headId      String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  head        User?    @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  creator     User     @relation("DepartmentCreator", fields: [createdById], references: [id])
  members     User[]   @relation("DepartmentMembers")
  projects    Project[]

  @@index([headId])
}

model Customer {
  id          String        @id @default(uuid())
  name        String
  industry    String?
  contactPerson String?
  email       String?
  phone       String?
  address     String?
  status      CustomerStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  projects    Project[]

  @@index([status])
  @@index([name])
}

model Stage {
  id            String   @id @default(uuid())
  name          String   @unique
  type          String   @default("Standard") // Standard or Temporary
  defaultWeight Float    @default(0) // Percentage
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  projectStages ProjectStage[]
  tasks         Task[]        @relation("StageTasks")
}

model Project {
  id              String        @id @default(uuid())
  code            String        @unique
  name            String
  description     String?
  customerId      String?
  managerId       String?
  departmentId    String?
  status          ProjectStatus @default(PLANNING)
  budget          Float         @default(0)
  startDate       DateTime?
  endDate         DateTime?
  healthScore     Float?        // 0-100
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  customer        Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  manager         User?         @relation("ProjectManager", fields: [managerId], references: [id], onDelete: SetNull)
  department      Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  creator         User          @relation("ProjectCreator", fields: [createdById], references: [id])
  members         ProjectMember[]
  stages          ProjectStage[]
  timesheets      Timesheet[]
  resources       Resource[]
  tasks           Task[]

  @@index([code])
  @@index([status])
  @@index([managerId])
  @@index([customerId])
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  assignedAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model ProjectStage {
  id          String      @id @default(uuid())
  projectId   String
  stageId     String
  weight      Float       @default(0) // Percentage
  status      StageStatus @default(OFF)
  completedDate DateTime?
  createdAt   DateTime    @default(now())

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stage       Stage       @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@unique([projectId, stageId])
  @@index([projectId])
}

model Timesheet {
  id          String          @id @default(uuid())
  userId      String
  projectId   String
  date        DateTime
  hours       Float           // 0.5-24
  description String?
  status      TimesheetStatus @default(DRAFT)
  approvedById String?
  approvedAt  DateTime?
  rejectedReason String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@index([status])
}

model Resource {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String   // Sitemap, Content, Design, Development, QA, Template, Library
  projectId   String?
  url         String?  // Google Drive or other external link
  accessLevel String   @default("Team") // Team, Public, Restricted
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([type])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String      @id @default(uuid())
  projectId   String
  assignedToId String?
  title       String
  description String?     @db.Text
  status      TaskStatus  @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  stageId     String?
  createdById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo  User?       @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  stage       Stage?      @relation(fields: [stageId], references: [id], onDelete: SetNull)
  creator     User        @relation("TaskCreator", fields: [createdById], references: [id])

  @@index([projectId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  entityType  String
  entityId    String?
  details     String?  @db.Text
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

